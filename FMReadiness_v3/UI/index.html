<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FM Readiness</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link id="mainStylesheet" rel="stylesheet" href="styles.css">
    <script>
        // Cache-bust static assets when hosted in WebView2.
        // The host sets ?v=<ticks> on index.html; reuse it for CSS/JS.
        (function () {
            const v = new URLSearchParams(window.location.search).get('v');
            if (!v) return;
            const css = document.getElementById('mainStylesheet');
            if (css) css.href = `styles.css?v=${encodeURIComponent(v)}`;
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- Header with Preset Selector -->
        <header class="header">
            <h1>FM Readiness</h1>
            <div class="header-meta">
                <div class="preset-selector">
                    <label for="presetDropdown">Preset:</label>
                    <select id="presetDropdown">
                        <option value="cobie-core.json">COBie Core</option>
                        <option value="fm-legacy.json">FM Legacy</option>
                    </select>
                    <button class="btn-icon btn-sm" id="refreshPresets" title="Refresh presets">⟳</button>
                </div>
                <div class="audit-profile-label" id="auditProfileLabel">Audit profile: --</div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="audit">Audit Results</button>
            <button class="tab-btn" data-tab="editor">Parameter Editor</button>
            <button class="tab-btn" data-tab="cobie">COBie Validation</button>
        </div>

        <!-- Tab: Audit Results -->
        <div id="tab-audit" class="tab-content active">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="card">
                    <div class="card-value" id="overallReadiness">--%</div>
                    <div class="card-label">Readiness</div>
                    <div class="card-sublabel">Overall score</div>
                </div>
                <div class="card">
                    <div class="card-value" id="fullyReadyCount">--</div>
                    <div class="card-label">Ready</div>
                    <div class="card-sublabel" id="fullyReadySublabel">-- assets complete</div>
                </div>
                <div class="card">
                    <div class="card-value" id="missingCount">--</div>
                    <div class="card-label">Missing Data</div>
                    <div class="card-sublabel" id="missingSublabel">-- assets incomplete</div>
                </div>
                <div class="card">
                    <div class="card-value" id="totalCount">--</div>
                    <div class="card-label">Total</div>
                    <div class="card-sublabel">Assets audited</div>
                </div>
            </div>

            <!-- Group Score Badges -->
            <div class="group-scores" id="groupScores">
                <!-- Populated by JS -->
            </div>
            <div class="category-scores" id="categoryScores">
                <!-- Populated by JS -->
            </div>

            <!-- Controls -->
            <div class="controls">
                <input type="text" id="searchInput" placeholder="Search or filter" />
                <label class="checkbox-label">
                    <input type="checkbox" id="showMissingOnly" />
                    Show only incomplete
                </label>
                <label class="audit-mode-label">
                    <span>Category</span>
                    <select id="categoryFilter" class="audit-mode-select">
                        <option value="all">All categories</option>
                    </select>
                </label>
                <label class="audit-mode-label">
                    <span>Audit scope</span>
                    <select id="auditScoreMode" class="audit-mode-select">
                        <option value="all" selected>All editable fields</option>
                        <option value="required">Required + unique only</option>
                    </select>
                </label>
            </div>

            <!-- Results Table -->
            <div class="table-wrapper">
                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Element ID</th>
                                <th>Status</th>
                                <th>Category</th>
                                <th>Family</th>
                                <th>Type</th>
                                <th>Readiness</th>
                                <th>Groups</th>
                                <th>Missing</th>
                                <th>View</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                    <div id="emptyState" class="empty-state">
                        Run an audit to see results
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Parameter Editor -->
        <div id="tab-editor" class="tab-content">
            <!-- Editor Mode Toggle -->
            <div class="editor-mode-toggle">
                <button class="mode-btn active" data-mode="cobie">COBie Editor</button>
                <button class="mode-btn" data-mode="legacy">Legacy FM Editor</button>
                <label class="checkbox-label write-aliases-toggle">
                    <input type="checkbox" id="writeAliases" checked>
                    Write to FM_ aliases
                </label>
            </div>

            <!-- Selected Elements Section (shared) -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Selected Elements</h3>
                    <button class="btn-secondary btn-sm" id="refreshSelection" title="Manually refresh the current Revit selection">Refresh</button>
                </div>
                <div class="selection-controls">
                    <div class="control-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="autoSyncSelection" checked title="Automatically sync when the Revit selection changes">
                            Auto-sync
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="lockSelection" checked title="Freeze the current selection while you edit fields">
                            Lock selection
                        </label>
                    </div>
                    <div class="control-group">
                        <label class="scope-label" for="selectionScope">Scope</label>
                        <select id="selectionScope" title="Choose how to build the selection set">
                            <option value="selection">Current selection</option>
                            <option value="activeView">Active view</option>
                            <option value="selectedType">All instances of selected type</option>
                            <option value="category">By category</option>
                        </select>
                        <select id="scopeCategory" class="scope-category hidden" title="Category used when Scope is set to By category">
                            <option value="">Select category</option>
                            <option value="OST_MechanicalEquipment">Mechanical Equipment</option>
                            <option value="OST_DuctTerminal">Duct Terminals</option>
                            <option value="OST_DuctAccessory">Duct Accessories</option>
                            <option value="OST_PipeAccessory">Pipe Accessories</option>
                        </select>
                        <button class="btn-secondary btn-sm" id="applyScope" title="Select elements based on the chosen scope">Apply Scope</button>
                    </div>
                </div>
                <div class="help-toggle" id="selectionHelpHeader">
                    <span>How to use</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div id="selectionHelpContent" class="help-content collapsed">
                    <ol>
                        <li>Select elements in Revit or use Scope + Apply Scope.</li>
                        <li>Auto-sync keeps the editor updated as selection changes.</li>
                        <li>Lock selection to prevent accidental changes while editing.</li>
                        <li>Click Refresh if you want a manual update.</li>
                    </ol>
                </div>
                <div id="selectedElementInfo" class="selection-info">
                    <p class="placeholder-text">Select elements in Revit to begin</p>
                </div>
                <div id="selectionTray" class="selection-tray hidden">
                    <button class="selection-tray-toggle" id="selectionTrayToggle" title="Expand selection list">
                        <span>Selection list</span>
                        <span id="selectionTrayCount" class="selection-tray-count">0</span>
                        <span class="collapse-icon">▼</span>
                    </button>
                    <div id="selectionTrayContent" class="selection-tray-content hidden">
                        <div class="selection-tray-actions">
                            <label class="checkbox-label">
                                <input type="checkbox" id="selectionTraySelectAll">
                                Select all
                            </label>
                            <button class="btn-secondary btn-sm" id="removeCheckedSelection" disabled>Remove checked</button>
                            <button class="btn-secondary btn-sm" id="keepCheckedSelection" disabled>Keep checked</button>
                            <button class="btn-secondary btn-sm" id="clearSelectionList">Clear all</button>
                        </div>
                        <div id="selectionTrayList" class="selection-tray-list"></div>
                    </div>
                </div>
                <div id="fixBanner" class="fix-banner hidden"></div>
                <!-- Multi-select legend (shown when multiple elements selected) -->
                <div id="multiSelectLegend" class="multi-select-legend hidden">
                    <span class="legend-item"><span class="legend-swatch common"></span> Same value</span>
                    <span class="legend-item"><span class="legend-swatch varies"></span> Values differ</span>
                    <span class="legend-item"><span class="legend-swatch modified"></span> Modified</span>
                </div>
            </section>

            <!-- COBie Editor Mode -->
            <div id="cobieEditorMode" class="editor-mode active">
                <div class="ensure-bar">
                    <button class="btn-secondary btn-sm" id="ensureCobieParams">Ensure COBie Parameters</button>
                    <label class="checkbox-label ensure-cleanup-toggle" title="Removes FM_ parameters from the project">
                        <input type="checkbox" id="removeFmAliases" checked>
                        Remove FM_ parameters
                    </label>
                    <span class="ensure-note">Adds COBie fields to Identity Data.</span>
                </div>
                <div id="cobieEnsureNotice" class="ensure-notice">
                    Please click <strong>Ensure COBie Parameters</strong> to enable editing.
                </div>
                <!-- COBie Instance Fields -->
                <section class="editor-section">
                    <div class="section-header">
                        <h3>Component Fields <span class="field-count" id="cobieInstanceFieldCount"></span></h3>
                    </div>
                    <div id="cobieInstanceForm" class="params-form hidden">
                        <div class="form-grid" id="cobieInstanceFieldsGrid">
                            <!-- Dynamically populated from preset -->
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="applyCobieToSelected">Apply to Selected</button>
                            <span class="preview-note" id="cobieSelectedPreview"></span>
                            <span class="form-hint">Fields with <span class="required-badge">●</span> are required for COBie</span>
                        </div>
                    </div>
                </section>

                <!-- COBie Type Fields -->
                <section class="editor-section">
                    <div class="section-header">
                        <h3>Type Fields <span class="field-count" id="cobieTypeFieldCount"></span></h3>
                    </div>
                    <div id="cobieTypeInfo" class="type-info">
                        <p class="placeholder-text">Select an element to edit type parameters</p>
                    </div>
                    <div id="cobieTypeForm" class="params-form hidden">
                        <div class="form-grid" id="cobieTypeFieldsGrid">
                            <!-- Dynamically populated from preset -->
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="applyCobieType">Update Type</button>
                            <span class="preview-note" id="cobieTypePreview"></span>
                            <span id="cobieTypeImpact" class="impact-info"></span>
                        </div>
                    </div>
                </section>

                <!-- COBie Bulk Fill -->
                <section class="editor-section">
                    <div class="section-header">
                        <h3>Bulk Fill by Category</h3>
                    </div>
                    <div class="category-selector">
                        <select id="cobieBulkCategory">
                            <option value="">Select Category</option>
                            <option value="OST_MechanicalEquipment">Mechanical Equipment</option>
                            <option value="OST_DuctTerminal">Duct Terminals</option>
                            <option value="OST_DuctAccessory">Duct Accessories</option>
                            <option value="OST_PipeAccessory">Pipe Accessories</option>
                            <option value="OST_Rooms">Rooms</option>
                            <option value="OST_MEPSpaces">MEP Spaces</option>
                        </select>
                        <span id="cobieCategoryCount" class="category-count"></span>
                    </div>
                    <div id="cobieBulkForm" class="params-form">
                        <div class="form-grid" id="cobieBulkFieldsGrid">
                            <!-- Dynamically populated with common fields -->
                        </div>
                        <div class="form-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="cobieOnlyFillBlanks" checked>
                                Only fill blank values
                            </label>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" id="applyCobieToCategory">Apply to Category</button>
                            <span class="preview-note" id="cobieCategoryPreview"></span>
                        </div>
                    </div>
                </section>

                <!-- Computed Values -->
                <section class="editor-section">
                    <div class="section-header">
                        <h3>Computed Values</h3>
                    </div>
                    <div id="cobieComputedValues" class="computed-values">
                        <div class="computed-row">
                            <span class="computed-label">UniqueId</span>
                            <span class="computed-value" id="cobie_computed_UniqueId">--</span>
                            <button class="btn-icon btn-sm" id="copyToSerialNumber" title="Copy to SerialNumber">→ SerialNumber</button>
                        </div>
                        <div class="computed-row">
                            <span class="computed-label">Level</span>
                            <span class="computed-value" id="cobie_computed_Level">--</span>
                        </div>
                        <div class="computed-row">
                            <span class="computed-label">Room/Space</span>
                            <span class="computed-value" id="cobie_computed_RoomSpace">--</span>
                            <button class="btn-icon btn-sm" id="copyToSpace" title="Copy to Space">→ Space</button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Legacy FM Editor Mode -->
            <div id="legacyEditorMode" class="editor-mode">
                <div class="ensure-bar">
                    <button class="btn-secondary btn-sm" id="ensureLegacyParams">Ensure Legacy FM Parameters</button>
                    <span class="ensure-note">Replaces COBie parameters in Identity Data.</span>
                </div>
                <section class="editor-section">
                    <div class="section-header">
                        <h3>Instance Parameters (Legacy FM)</h3>
                    </div>
                    <div id="instanceParamsForm" class="params-form hidden">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>FM_Barcode</label>
                            <input type="text" id="edit_FM_Barcode" placeholder="Barcode/QR code">
                        </div>
                        <div class="form-group">
                            <label>FM_UniqueAssetId</label>
                            <input type="text" id="edit_FM_UniqueAssetId" placeholder="CMMS Asset ID">
                        </div>
                        <div class="form-group">
                            <label>FM_InstallationDate</label>
                            <input type="text" id="edit_FM_InstallationDate" placeholder="YYYY-MM-DD">
                        </div>
                        <div class="form-group">
                            <label>FM_WarrantyStart</label>
                            <input type="text" id="edit_FM_WarrantyStart" placeholder="YYYY-MM-DD">
                        </div>
                        <div class="form-group">
                            <label>FM_WarrantyEnd</label>
                            <input type="text" id="edit_FM_WarrantyEnd" placeholder="YYYY-MM-DD">
                        </div>
                        <div class="form-group">
                            <label>FM_Criticality</label>
                            <select id="edit_FM_Criticality">
                                <option value="">Select</option>
                                <option value="1">1 - Low</option>
                                <option value="2">2</option>
                                <option value="3">3 - Medium</option>
                                <option value="4">4</option>
                                <option value="5">5 - Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>FM_Trade</label>
                            <input type="text" id="edit_FM_Trade" placeholder="HVAC, Electrical, etc.">
                        </div>
                        <div class="form-group">
                            <label>FM_PMTemplateId</label>
                            <input type="text" id="edit_FM_PMTemplateId" placeholder="PM Template ID">
                        </div>
                        <div class="form-group">
                            <label>FM_PMFrequencyDays</label>
                            <input type="number" id="edit_FM_PMFrequencyDays" placeholder="90">
                        </div>
                        <div class="form-group">
                            <label>FM_Building</label>
                            <input type="text" id="edit_FM_Building" placeholder="Building name">
                        </div>
                        <div class="form-group">
                            <label>FM_LocationSpace</label>
                            <input type="text" id="edit_FM_LocationSpace" placeholder="Location override">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="applyToSelected">Apply to Selected</button>
                        <span class="preview-note" id="legacySelectedPreview"></span>
                    </div>
                </div>
            </section>

            <!-- Category Bulk Fill Section (Legacy) -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Category Bulk Fill (Legacy)</h3>
                </div>
                <div class="category-selector">
                    <select id="bulkCategory">
                        <option value="">Select Category</option>
                        <option value="OST_MechanicalEquipment">Mechanical Equipment</option>
                        <option value="OST_DuctTerminal">Duct Terminals</option>
                        <option value="OST_DuctAccessory">Duct Accessories</option>
                        <option value="OST_PipeAccessory">Pipe Accessories</option>
                    </select>
                    <span id="categoryCount" class="category-count"></span>
                </div>
                <div id="bulkParamsForm" class="params-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>FM_Building</label>
                            <input type="text" id="bulk_FM_Building" placeholder="Apply to all">
                        </div>
                        <div class="form-group">
                            <label>FM_Trade</label>
                            <input type="text" id="bulk_FM_Trade" placeholder="Apply to all">
                        </div>
                        <div class="form-group">
                            <label>FM_PMFrequencyDays</label>
                            <input type="number" id="bulk_FM_PMFrequencyDays" placeholder="Apply to all">
                        </div>
                        <div class="form-group">
                            <label>FM_Criticality</label>
                            <select id="bulk_FM_Criticality">
                                <option value="">No Change</option>
                                <option value="1">1 - Low</option>
                                <option value="2">2</option>
                                <option value="3">3 - Medium</option>
                                <option value="4">4</option>
                                <option value="5">5 - Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="onlyFillBlanks" checked>
                            Only fill blank values
                        </label>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="applyToCategory">Apply to Category</button>
                        <span class="preview-note" id="legacyCategoryPreview"></span>
                    </div>
                </div>
            </section>

            <!-- Type Parameters Section (Legacy) -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Type Parameters (Legacy)</h3>
                </div>
                <div id="typeInfo" class="type-info">
                    <p class="placeholder-text">Select an element to edit type parameters</p>
                </div>
                <div id="typeParamsForm" class="params-form hidden">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Manufacturer</label>
                            <input type="text" id="type_Manufacturer" placeholder="Manufacturer name">
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="type_Model" placeholder="Model number">
                        </div>
                        <div class="form-group">
                            <label>Type Mark</label>
                            <input type="text" id="type_TypeMark" placeholder="Type mark">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" id="updateType">Update Type</button>
                        <span class="preview-note" id="legacyTypePreview"></span>
                        <span id="typeImpact" class="impact-info"></span>
                    </div>
                </div>
            </section>

            <!-- Computed Values & Helpers Section (Legacy) -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Computed Values (Legacy)</h3>
                </div>
                <div id="computedValues" class="computed-values">
                    <div class="computed-row">
                        <span class="computed-label">UniqueId</span>
                        <span class="computed-value" id="computed_UniqueId">--</span>
                        <button class="btn-icon" id="copyUniqueId" title="Copy">Copy</button>
                    </div>
                    <div class="computed-row">
                        <span class="computed-label">Level</span>
                        <span class="computed-value" id="computed_Level">--</span>
                    </div>
                    <div class="computed-row">
                        <span class="computed-label">Room/Space</span>
                        <span class="computed-value" id="computed_RoomSpace">--</span>
                    </div>
                </div>
                <div class="helper-actions">
                    <button class="btn-secondary" id="copyUniqueIdToParam">
                        Copy UniqueId → FM_UniqueAssetId
                    </button>
                    <button class="btn-secondary" id="populateLocationSpace">
                        Populate FM_LocationSpace from Room
                    </button>
                </div>
            </section>
            </div><!-- End Legacy Editor Mode -->
        </div>

        <!-- Tab: COBie Validation -->
        <div id="tab-cobie" class="tab-content">
            <!-- COBie Readiness Summary -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>COBie Readiness Summary</h3>
                    <button class="btn-primary btn-sm" id="validateCobieBtn">Validate Selected</button>
                </div>
                <div id="cobieReadinessSummary" class="cobie-summary">
                    <div class="cobie-summary-cards">
                        <div class="cobie-card">
                            <div class="cobie-card-value" id="cobieOverallScore">--%</div>
                            <div class="cobie-card-label">Overall Score</div>
                        </div>
                        <div class="cobie-card">
                            <div class="cobie-card-value" id="cobieReadyCount">--</div>
                            <div class="cobie-card-label">COBie Ready</div>
                        </div>
                        <div class="cobie-card">
                            <div class="cobie-card-value" id="cobieRequiredScore">--%</div>
                            <div class="cobie-card-label">Required Fields</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Validation Results -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Validation Results</h3>
                </div>
                <div id="cobieValidationResults" class="validation-results">
                    <p class="placeholder-text">Select elements in Revit and click "Validate Selected" to check COBie readiness.</p>
                </div>
            </section>

            <!-- Uniqueness Violations -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Uniqueness Violations</h3>
                </div>
                <div id="uniquenessViolations" class="violations-list">
                    <p class="placeholder-text">No uniqueness violations detected.</p>
                </div>
            </section>

            <!-- Missing Required Fields -->
            <section class="editor-section">
                <div class="section-header">
                    <h3>Missing Required Fields</h3>
                </div>
                <div id="missingRequiredFields" class="missing-fields-list">
                    <p class="placeholder-text">Run validation to see missing required fields.</p>
                </div>
            </section>

            <!-- COBie Field Reference -->
            <section class="editor-section collapsible">
                <div class="section-header" id="cobieFieldRefHeader">
                    <h3>COBie Field Reference</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div id="cobieFieldReference" class="field-reference collapsed">
                    <div class="field-ref-group" id="componentFieldsRef">
                        <h4>Component Fields</h4>
                        <div class="field-ref-list"></div>
                    </div>
                    <div class="field-ref-group" id="typeFieldsRef">
                        <h4>Type Fields</h4>
                        <div class="field-ref-list"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        (function () {
            const v = new URLSearchParams(window.location.search).get('v');
            const s = document.createElement('script');
            s.src = v ? `app.js?v=${encodeURIComponent(v)}` : 'app.js';
            document.body.appendChild(s);
        })();
    </script>
</body>
</html>
